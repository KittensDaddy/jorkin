<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay GIF on Image, GIF, or Video</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        #preview {
            display: none;
            margin-top: 20px;
            max-width: 100%;
            height: auto;
        }
        #status {
            margin-top: 20px;
        }
        #downloadButton {
            display: none;
            margin-top: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>
</head>
<body>
    <h1>Overlay GIF on Image, GIF, or Video</h1>

    <label for="imageUrl">Enter Image, GIF, or Video URL:</label>
    <input type="text" id="imageUrl" placeholder="Enter URL">
    <button id="processButton">Process</button>
    
    <p id="status">Ready</p>

    <canvas id="canvas" style="display: none;"></canvas>

    <img id="preview" alt="Preview of GIF">
    
    <a id="downloadLink" href="" style="display:none;">
        <button id="downloadButton">Download Processed GIF</button>
    </a>

    <script>
        document.getElementById('processButton').addEventListener('click', function() {
            const url = document.getElementById('imageUrl').value;
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const status = document.getElementById('status');
            const preview = document.getElementById('preview');
            const downloadButton = document.getElementById('downloadButton');
            const downloadLink = document.getElementById('downloadLink');
            const gifUrl = "jorkin.gif"; // The moving overlay GIF

            status.textContent = "Processing...";

            // Clear previous content
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            preview.style.display = "none";
            downloadButton.style.display = "none";

            const img = new Image();
            img.crossOrigin = "anonymous"; // Allow cross-origin images
            img.onload = function() {
                // Set canvas size based on the image
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                processOverlayGif();
            };

            img.onerror = function() {
                // If image fails, try loading as a video
                const video = document.createElement('video');
                video.src = url;
                video.crossOrigin = "anonymous";
                
                video.onloadeddata = function() {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    video.play();
                    function drawFrame() {
                        ctx.drawImage(video, 0, 0);
                        processOverlayGif();
                        if (!video.paused && !video.ended) {
                            requestAnimationFrame(drawFrame);
                        }
                    }
                    drawFrame();
                };

                video.onerror = function() {
                    status.textContent = "Error loading image, GIF, or video.";
                };
            };

            img.src = url;

            function processOverlayGif() {
                const gif = new Image();
                gif.src = gifUrl;
                
                gif.onload = function() {
                    const gifWidth = gif.width;
                    const gifHeight = gif.height;
                    const gifX = (canvas.width - gifWidth) / 2;
                    const gifY = (canvas.height - gifHeight) / 2;

                    const gifGenerator = new GIF({
                        workers: 2,
                        quality: 10,
                        width: canvas.width,
                        height: canvas.height,
                        frameDelay: 100,
                        transparent: 0xFFFFFF,
                        workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'
                    });

                    let frameIndex = 0;

                    function drawGifFrame() {
                        // Redraw the background image/video
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(gif, gifX, gifY);

                        // Add the current canvas frame to the GIF generator
                        gifGenerator.addFrame(canvas, { copy: true, delay: 50 });

                        frameIndex++;

                        // Show the preview
                        preview.src = canvas.toDataURL();
                        preview.style.display = "block";

                        if (frameIndex < 30) { // Process a limited number of frames
                            requestAnimationFrame(drawGifFrame);
                        } else {
                            gifGenerator.on('finished', function(blob) {
                                const url = URL.createObjectURL(blob);
                                downloadLink.href = url;
                                downloadButton.style.display = "block";
                                status.textContent = "Processing complete.";
                            });
                            gifGenerator.render(); // Render and finalize the GIF
                        }
                    }

                    drawGifFrame();
                };
            }
        });
    </script>
</body>
</html>
