<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay GIF onto Image or Video</title>
    <style>
        #preview {
            display: none;
            max-width: 100%;
        }
        #downloadButton {
            display: none;
            margin-top: 20px;
        }
    </style>
	    <!-- Add GIF.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>

</head>
<body>
    <h1>Overlay GIF onto Image, GIF, or Video</h1>

    <label for="imageUrl">Enter Image, GIF, or Video URL:</label>
    <input type="text" id="imageUrl" placeholder="Enter URL of image, GIF, or video">
    
    <button id="processButton">Process</button>
    
    <p id="status">Ready</p>
    
    <canvas id="canvas" style="display:none;"></canvas>
    
    <img id="preview" alt="Preview of GIF" />

    <a id="downloadLink" href="" style="display:none;">
        <button id="downloadButton">Download Processed GIF</button>
    </a>

    <script>
        document.getElementById('processButton').addEventListener('click', function() {
            const url = document.getElementById('imageUrl').value;
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const status = document.getElementById('status');
            const preview = document.getElementById('preview');
            const downloadButton = document.getElementById('downloadButton');
            const downloadLink = document.getElementById('downloadLink');

            status.textContent = "Processing...";

            // Clear previous canvas or preview
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            preview.style.display = "none";
            downloadButton.style.display = "none";

            const img = new Image();
            img.onload = function() {
                // Set canvas size based on image size
                canvas.width = img.width;
                canvas.height = img.height;

                // Draw the image onto the canvas
                ctx.drawImage(img, 0, 0);
                overlayGifOnCanvas(canvas, ctx);
            };

            img.onerror = function() {
                // If image fails, attempt to load a video
                const video = document.createElement('video');
                video.src = url;
                video.crossOrigin = 'anonymous';

                video.onloadeddata = function() {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    video.play();
                    // Draw each video frame onto canvas
                    function drawFrame() {
                        ctx.drawImage(video, 0, 0);
                        overlayGifOnCanvas(canvas, ctx);
                        if (!video.paused && !video.ended) {
                            requestAnimationFrame(drawFrame);
                        }
                    }
                    drawFrame();
                };

                video.onerror = function() {
                    status.textContent = "Error loading image, GIF, or video.";
                };
            };

            img.src = url;
        });

        function overlayGifOnCanvas(canvas, ctx) {
            const gif = new Image();
            gif.src = "jorkin.gif"; // The moving overlay GIF
            gif.onload = function() {
                const gifWidth = gif.width;
                const gifHeight = gif.height;
                const gifX = (canvas.width - gifWidth) / 2;
                const gifY = (canvas.height - gifHeight) / 2;

                // Create the GIF.js object with a higher frame rate and quality control
                const gifGenerator = new GIF({
                    workers: 2,
                    quality: 10,  // Lower quality to reduce file size
                    width: canvas.width,
                    height: canvas.height,
                    frameDelay: 100, // Frame delay to control speed (higher delay = slower)
                    transparent: 0xFFFFFF,
                    workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js'
					
                });

                // Add frames to the gifGenerator as we draw the gif
                let frameIndex = 0;

                function drawGifFrame() {
                    // Redraw the image or video on the canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(gif, gifX, gifY);

                    // Add frame to gif generator
                    gifGenerator.addFrame(canvas, { copy: true, delay: 50 });

                    frameIndex++;

                    // Show the preview image
                    const preview = document.getElementById('preview');
                    preview.src = canvas.toDataURL();
                    preview.style.display = "block";

                    // Check the file size, stop adding frames if it exceeds the limit
                    if (frameIndex < 20 && gifGenerator.getBytes() < 2 * 1024 * 1024) {
                        requestAnimationFrame(drawGifFrame);
                    } else {
                        // Process the GIF and generate download link
                        gifGenerator.on('finished', function(blob) {
                            const url = URL.createObjectURL(blob);
                            downloadLink.href = url;
                            downloadButton.style.display = "block";
                            status.textContent = "Processing complete.";
                        });

                        gifGenerator.render();
                    }
                }

                drawGifFrame();
            };
        }
    </script>
</body>
</html>
